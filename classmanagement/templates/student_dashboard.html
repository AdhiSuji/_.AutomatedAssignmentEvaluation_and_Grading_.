{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">

    <h2 class="mb-4">üìä Student Dashboard</h2>

        <div class="text-end">
            <a href="{% url 'student_profile' %}" class="btn" style="background-color: #6f42c1; color: white;">Profile</a>
        </div>


      <!-- ‚úÖ Grades Table -->
    <h4>Your Submitted Assignments & Grades</h4>
    <table class="table table-bordered mt-3">
        <thead class="thead-dark">
            <tr>
                <th>Assignment</th>
                <th>Marks</th>
                <th>Grade</th>
                <th>Feedback</th>
                <th>Progress</th>
            </tr>
        </thead>
        <tbody>
            {% for submission in submissions %}
            <tr>
                <td>{{ submission.assignment.title }}</td>
                <td>{{ submission.total_marks }}</td>
                <td>{{ submission.grade }}</td>
                <td>{{ submission.feedback }}</td>
                <td>
                    <a href="{% url 'progress_chart' submission.assignment.id %}" class="btn btn-primary">
                        View 
                    </a>                                        
                </td>                
            </tr>
            {% empty %}
            <tr>
                <td colspan="5">No assignments submitted yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ‚úÖ Top Performers in Class -->
    <h4 class="mt-5">üèÜ Top 3 Performers in {{ current_class.name }}</h4>
    <table class="table table-bordered mt-3">
        <thead class="thead-light">
            <tr>
                <th>Rank</th>
                <th>Student Name</th>
                <th>Overall Score</th>
            </tr>
        </thead>
        <tbody>
            {% for student in top_performers %}
            <tr>
                <td>
                    {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% endif %}
                    {{ forloop.counter }}
                </td>
                <td>{{ student.student_name }}</td>
                <td>{{ student.overall_score }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3">No data available yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    

<!-- ‚úÖ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const studentPerformance = JSON.parse('{{ student_performance_json|escapejs }}');
    const classPerformance = JSON.parse('{{ avg_class_performance_json|escapejs }}');

    const assignmentLabels = studentPerformance.map(item => item.assignment);
    const studentScores = studentPerformance.map(item => item.marks);
    const classScores = assignmentLabels.map(title => classPerformance[title] || 0);

    const ctx1 = document.getElementById('studentPerformanceChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: assignmentLabels,
            datasets: [{
                label: 'Your Marks',
                data: studentScores,
                borderColor: 'blue',
                fill: false,
                tension: 0.3
            }]
        }
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const studentPerformance = JSON.parse('{{ student_performance_json|escapejs }}');
        const avgClassPerformance = JSON.parse('{{ avg_class_performance_json|escapejs }}');
    
        document.querySelectorAll(".view-progress").forEach(button => {
            button.addEventListener("click", function () {
                // Close any open charts first
                document.querySelectorAll(".progress-chart-container").forEach(div => {
                    div.style.display = "none";
                });
    
                // Find the relevant div & canvas
                const chartContainer = this.nextElementSibling;
                const canvas = chartContainer.querySelector(".progress-chart");
                chartContainer.style.display = "block";
    
                // Get assignment data
                const assignment = this.dataset.assignment;
                const studentMarks = studentPerformance.find(s => s.assignment === assignment)?.marks || 0;
                const classAvg = avgClassPerformance[assignment] || 0;
    
                // Destroy previous chart if exists
                if (canvas.chartInstance) {
                    canvas.chartInstance.destroy();
                }
                
        });
    });
    </script>

    <!-- Firecracker Sound Player -->
    <audio id="firecrackerSound" src="{% static 'sounds/firecracker.mp3' %}" preload="auto"></audio>
    
    <!-- Full-Screen Congratulations Message -->
    <div id="congratulationsMessage" class="congratulations-overlay">
      <div class="congratulations-content">
        <h2>üéâ Congrats, {{ request.user.first_name }}!</h2>
        <p>You're one of the Top 3 performers in {{ current_class.name }}! Keep it up! üåü</p>
        <p>We‚Äôre proud of your hard work and dedication! üíØ</p>
      </div>
    </div>
    
    <!-- Confetti Script -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loggedInStudentName = "{{ request.user.first_name }} {{ request.user.last_name }}".trim();
        const topPerformers = {{ top_performers|safe }};
        
        // Check if the logged-in user is in the Top 3 performers
        const isTopPerformer = topPerformers.some(p => p.student_name === loggedInStudentName);
        
        if (isTopPerformer) {
          // Wait a second before starting the celebrations
          setTimeout(() => {
            // üéÜ Firecracker Confetti
            confetti({
              particleCount: 500,
              spread: 1000,
              origin: { y: 0.6 },
            });
    
            // üîä Attempt to play sound
            const sound = document.getElementById("firecrackerSound");
            const playPromise = sound.play();
            
            if (playPromise !== undefined) {
              playPromise.then(() => {
                console.log("üî• Sound played!");
              }).catch(error => {
                console.log("üö´ Sound autoplay blocked by browser:", error);
              });
            }
    
            // Show the full-screen congratulations message
            const congratsMessage = document.getElementById("congratulationsMessage");
            congratsMessage.classList.add("show");
    
            // After 5 seconds, hide the message
            setTimeout(function () {
              congratsMessage.classList.remove("show");
            }, 5000);  // 5 seconds delay before fading out
          }, 1000);  // Delay to ensure user interaction is registered
        }
      });
    </script>
    
    
        <!-- Add CSS for full-screen overlay -->
        <style>
          /* Full-Screen Overlay */
          .congratulations-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);  /* Dark background with transparency */
            color: #fff;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 2s ease-in-out;
          }
      
          .congratulations-overlay.show {
            display: flex;
            opacity: 1;
          }
      
          .congratulations-content {
            font-family: 'Poppins', sans-serif;  /* Stylish font */
            background: linear-gradient(45deg, #ff4b5c, #ff6f61, #f77f00);  /* Gradient colorful background */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 600px;
            animation: popIn 1s ease-in-out;
          }
      
          .congratulations-content h2 {
            font-size: 3rem;
            margin-bottom: 20px;
            font-weight: bold;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.3);  /* Text shadow for extra pop */
          }
      
          .congratulations-content p {
            font-size: 1.8rem;
            color: #fff;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
          }
      
          /* Fading out effect */
          .congratulations-overlay.fade-out {
            opacity: 0;
            transition: opacity 2s ease-in-out;
          }
      
          /* Keyframe animation for the "pop-in" effect */
          @keyframes popIn {
            0% {
              transform: scale(0);
              opacity: 0;
            }
            100% {
              transform: scale(1);
              opacity: 1;
            }
          }
        </style>
    
      

{% endblock %}
